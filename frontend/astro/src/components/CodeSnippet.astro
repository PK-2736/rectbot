---
export interface Props {
  title?: string;
  filename?: string;
  language?: string;
  code: string;
  startingLine?: number;
  highlights?: number[];
  compact?: boolean;
}

const {
  title = '',
  filename = '',
  language = 'bash',
  code,
  startingLine = 1,
  highlights = [],
  compact = false,
} = Astro.props as Props;

function escapeHtml(str: string) {
  return str
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;');
}

const lines = code.replace(/\n$/,'').split('\n');
---
<figure class={`rounded-2xl border border-brand-200/70 bg-white/70 backdrop-blur shadow-lg ${compact ? 'p-3' : 'p-4'} code-snippet`}> 
  {(title || filename) && (
    <header class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-3 min-w-0">
        <div class="flex gap-1.5">
          <span class="block h-2.5 w-2.5 rounded-full bg-red-400/80"></span>
          <span class="block h-2.5 w-2.5 rounded-full bg-yellow-400/80"></span>
          <span class="block h-2.5 w-2.5 rounded-full bg-green-400/80"></span>
        </div>
        <div class="truncate">
          {title && (<figcaption class="text-sm font-semibold text-slate-800 truncate">{title}</figcaption>)}
          {filename && (<div class="text-[12px] text-slate-500 truncate">{filename}</div>)}
        </div>
      </div>
      <button class="copy-btn text-xs px-2.5 py-1.5 rounded-md border border-brand-200 bg-white hover:bg-brand-50 text-slate-700 transition-colors" aria-label="Copy code">
        コピー
      </button>
    </header>
  )}

  <div class="relative rounded-xl overflow-hidden ring-1 ring-brand-100">
    <pre class="m-0 overflow-x-auto bg-gradient-to-br from-slate-50 to-white"><code class={`block text-[13px] leading-6 font-mono whitespace-pre min-w-full language-${language}`}>{lines.map((text, i) => {
  const n = startingLine + i;
  const isHl = highlights.includes(n);
  return (
    <div class={`grid grid-cols-[auto_1fr] gap-4 pr-4 ${isHl ? 'bg-yellow-50' : ''}`}>
      <span class="select-none text-right pl-3 pr-2 text-slate-400 tabular-nums">{n}</span>
      <span class="block text-slate-800" set:html={escapeHtml(text)}></span>
    </div>
  );
})}</code></pre>
    <div class="pointer-events-none absolute inset-0 ring-1 ring-inset ring-black/3 rounded-xl"></div>
  </div>
</figure>

<script>
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.code-snippet').forEach((snippet) => {
      const btn = snippet.querySelector('.copy-btn') as HTMLButtonElement | null;
      const codeEl = snippet.querySelector('pre code') as HTMLElement | null;
      if (btn && codeEl) {
        btn.addEventListener('click', async () => {
          try {
            const raw = Array.from(codeEl.querySelectorAll('span.block'))
              .map((el) => el.textContent ?? '')
              .join('\n');
            await navigator.clipboard.writeText(raw);
            const original = btn.textContent;
            btn.textContent = 'コピー完了';
            btn.classList.add('bg-brand-500','text-white','border-brand-500');
            setTimeout(() => {
              btn.textContent = original ?? 'コピー';
              btn.classList.remove('bg-brand-500','text-white','border-brand-500');
            }, 1200);
          } catch (e) {
            console.error('copy failed', e);
          }
        });
      }
    });
  });
</script>

<style>
  .code-snippet {
    background-image: radial-gradient(60% 140% at 100% -10%, rgba(255,61,138,0.08), transparent 45%),
                      radial-gradient(60% 140% at -10% 120%, rgba(255,126,66,0.08), transparent 45%);
  }
  .code-snippet pre {
    padding: 14px 0;
  }
</style>
