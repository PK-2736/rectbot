# Caddy reverse proxy for Grafana (Cloudflare proxy in front)
# Domain: https://grafana.recrubo.net
# 運用モード:
# - Cloudflare プロキシ有効（推奨）: Cloudflare Origin 証明書を使用
#   * Cloudflare ダッシュボードで Origin Certificate を発行し、以下に配置:
#     /workspaces/rectbot/docker/monitoring/tls/origin.crt
#     /workspaces/rectbot/docker/monitoring/tls/origin.key
#   * Caddy では /etc/caddy/certs/ にマウント済み（compose）
#   * Cloudflare 側の SSL/TLS モードは「Full (strict)」を推奨
# - Cloudflare プロキシ無効 (DNS only) 一時運用: Let's Encrypt (ACME) 自動取得
#   * 下の tls ディレクティブをコメントアウトし、DNS を灰色雲にして 80/443 公開で自動取得

grafana.recrubo.net {
  # Cloudflare Origin 証明書（CF プロキシ有効時推奨）
  tls /etc/caddy/certs/origin.crt /etc/caddy/certs/origin.key

  encode zstd gzip

  log {
    output stdout
    format console
  }

  # 追加のセキュリティヘッダ
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    Referrer-Policy "no-referrer"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
    X-Frame-Options "DENY"
  }

  # 逆プロキシ: Docker ネットワーク上の grafana コンテナへ
  reverse_proxy http://grafana:3000 {
    # Cloudflare 経由の実クライアント IP を上流へ伝搬
    # CF は `CF-Connecting-IP` を付与するため、それを優先使用
    header_up X-Real-IP {header.CF-Connecting-IP}
    header_up X-Forwarded-For {header.CF-Connecting-IP}
    header_up X-Forwarded-Proto {scheme}
    header_up Host {host}
    transport http {
      versions h2c 1.1
    }
  }
}
