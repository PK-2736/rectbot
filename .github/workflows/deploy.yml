name: Deploy to OCI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  oci-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Set up SSH key (id_ed25519)
        env:
          OCI_SSH_KEY: ${{ secrets.OCI_SSH_KEY }}
          OCI_HOST: ${{ secrets.OCI_HOST }}
        run: |
          mkdir -p ~/.ssh
          # Support raw PEM or base64-encoded private key
          if printf '%s' "$OCI_SSH_KEY" | grep -q -- "-----BEGIN"; then
            printf '%s' "$OCI_SSH_KEY" | sed 's/\r$//' > ~/.ssh/id_ed25519
          else
            printf '%s' "$OCI_SSH_KEY" | tr -d '\r' | base64 -d > ~/.ssh/id_ed25519
          fi
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H $OCI_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Output public key fingerprint for debugging
          ssh-keygen -y -f ~/.ssh/id_ed25519 | ssh-keygen -lf - || true

          # Quick non-interactive SSH test to surface authentication errors
          set +e
          ssh -i ~/.ssh/id_ed25519 -o BatchMode=yes -o StrictHostKeyChecking=no ${{ secrets.OCI_USER }}@${OCI_HOST} 'echo SSH-OK' >/tmp/ssh_test_output 2>&1
          SSH_TEST_EXIT=$?
          set -e
          if [ ${SSH_TEST_EXIT} -ne 0 ]; then
            echo "ERROR: SSH test connection failed (exit=${SSH_TEST_EXIT}). Output:" >&2
            sed -n '1,200p' /tmp/ssh_test_output || true
            exit ${SSH_TEST_EXIT}
      - name: Create .env file for docker compose
        run: |
          echo "GRAFANA_ADMIN_USER=${{ secrets.GRAFANA_ADMIN_USER }}" > .env
          echo "GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}" >> .env
          echo "GRAFANA_TOKEN=${{ secrets.GRAFANA_TOKEN }}" >> .env
          GRAFANA_DOMAIN="${{ secrets.GRAFANA_DOMAIN }}"
          if [ -z "$GRAFANA_DOMAIN" ]; then GRAFANA_DOMAIN="grafana.recrubo.net"; fi
          echo "GRAFANA_DOMAIN=$GRAFANA_DOMAIN" >> .env
          GRAFANA_ROOT_URL="${{ secrets.GRAFANA_ROOT_URL }}"
          if [ -z "$GRAFANA_ROOT_URL" ]; then GRAFANA_ROOT_URL="https://grafana.recrubo.net/"; fi
          echo "GRAFANA_ROOT_URL=$GRAFANA_ROOT_URL" >> .env
      - name: Deploy via SSH (production)
        env:
          OCI_USER: ${{ secrets.OCI_USER }}
          OCI_HOST: ${{ secrets.OCI_HOST }}
          GRAFANA_ADMIN_USER: ${{ secrets.GRAFANA_ADMIN_USER }}
          GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no $OCI_USER@$OCI_HOST '
            source ~/.bashrc || true; \
            source ~/.nvm/nvm.sh || true; \
            cd ~/rectbot || exit 1; \
            git pull origin main || true; \

            # Create .env file temporarily
            echo "GRAFANA_ADMIN_USER='"$GRAFANA_ADMIN_USER"'" > .env; \
            echo "GRAFANA_ADMIN_PASSWORD='"$GRAFANA_ADMIN_PASSWORD"'" >> .env; \
            echo "GRAFANA_TOKEN='"$GRAFANA_TOKEN"'" >> .env; \
            GRAFANA_DOMAIN="grafana.recrubo.net"; \
            echo "GRAFANA_DOMAIN=$GRAFANA_DOMAIN" >> .env; \
            GRAFANA_ROOT_URL="https://grafana.recrubo.net/"; \
            echo "GRAFANA_ROOT_URL=$GRAFANA_ROOT_URL" >> .env; \

            # Monitoring stack (Grafana/Loki/Promtail/Prometheus/Pushgateway)
            echo "Deploying monitoring stack (docker compose)..."; \
            docker compose -f docker-compose.monitoring.yml pull || true; \
            docker compose -f docker-compose.monitoring.yml build log-receiver || true; \
              # Grafanaを完全に再作成してデータソース設定をリセット（ボリュームごと削除）
              echo "Recreating Grafana with fresh volume to fix datasource conflicts..."; \
              docker compose -f docker-compose.monitoring.yml stop grafana || true; \
              docker compose -f docker-compose.monitoring.yml rm -v -f grafana || true; \
              docker volume rm rectbot_grafana_data || true; \
              # Exclude pushgateway-proxy to prevent failure when host files are missing
              docker compose -f docker-compose.monitoring.yml up -d --remove-orphans loki promtail log-receiver prometheus grafana node-exporter cadvisor pushgateway; \
            echo "Checking Grafana status..."; \
            sleep 35; \
            docker logs grafana --tail 50 || true; \
            docker ps --filter "name=grafana" || true; \
            echo "Checking Grafana datasources..."; \
            GRAFANA_ADMIN_USER=$(grep '\''^GRAFANA_ADMIN_USER='\'' .env | cut -d'\''='\'' -f2); \
            GRAFANA_ADMIN_PASSWORD=$(grep '\''^GRAFANA_ADMIN_PASSWORD='\'' .env | cut -d'\''='\'' -f2); \
            curl -s -u "$GRAFANA_ADMIN_USER:$GRAFANA_ADMIN_PASSWORD" https://grafana.recrubo.net/api/datasources | jq . || true; \

            # Clean up .env file
            rm .env;
          '