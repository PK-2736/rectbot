name: Keep Supabase Active

# Supabase無料枠の凍結を回避するため、定期的にデータベースにアクセス
# 毎日午前0時(UTC)に実行 = 日本時間午前9時

on:
  schedule:
    # 毎日 00:00 UTC (JST 09:00) に実行
    - cron: '0 0 * * *'
  
  # 手動実行も許可
  workflow_dispatch:

jobs:
  keep-alive:
    name: Keep Supabase Database Active
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Ping Supabase Database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Supabaseに簡単なクエリを実行
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${SUPABASE_URL}/rest/v1/rpc/keep_alive" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d '{}')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          # ステータスコードをファイルに保存（次のステップで使用）
          echo "$HTTP_CODE" > /tmp/http_code.txt
          
          # 404エラーは関数が存在しない場合なので、代替方法を試す
          if [ "$HTTP_CODE" = "404" ]; then
            echo "RPC function not found, trying alternative method..."
            
            # guild_settingsテーブルから1件取得（読み取りのみ）
            ALT_RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X GET "${SUPABASE_URL}/rest/v1/guild_settings?select=id&limit=1" \
              -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
              -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}")
            
            ALT_HTTP_CODE=$(echo "$ALT_RESPONSE" | tail -n1)
            ALT_BODY=$(echo "$ALT_RESPONSE" | head -n-1)
            
            echo "Alternative HTTP Status: $ALT_HTTP_CODE"
            echo "Alternative Response: $ALT_BODY"
            echo "$ALT_HTTP_CODE" > /tmp/http_code.txt
          fi
      
      - name: Send Discord Notification on Success
        if: success()
        env:
          DISCORD_WEBHOOK_URL: https://discord.com/api/webhooks/1426044588740710460/RElua00Jvi-937tbGtwv9wfq123mdff097HvaJgb-qILNsc79yzei9x8vZrM2OKYsETI
        run: |
          HTTP_CODE=$(cat /tmp/http_code.txt 2>/dev/null || echo "unknown")
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"✅ Supabase Keep-Alive Success\",
                \"description\": \"Supabaseデータベースへの定期アクセスが成功しました\",
                \"color\": 3066993,
                \"fields\": [
                  {
                    \"name\": \"実行時刻\",
                    \"value\": \"${TIMESTAMP}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"HTTPステータス\",
                    \"value\": \"${HTTP_CODE}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ワークフロー\",
                    \"value\": \"[${GITHUB_WORKFLOW}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\",
                    \"inline\": false
                  }
                ],
                \"footer\": {
                  \"text\": \"GitHub Actions - Supabase Keep-Alive\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" \
            "${DISCORD_WEBHOOK_URL}"
      
      - name: Send Discord Notification on Failure
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: https://discord.com/api/webhooks/1426044588740710460/RElua00Jvi-937tbGtwv9wfq123mdff097HvaJgb-qILNsc79yzei9x8vZrM2OKYsETI
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"❌ Supabase Keep-Alive Failed\",
                \"description\": \"Supabaseデータベースへのアクセスに失敗しました\",
                \"color\": 15158332,
                \"fields\": [
                  {
                    \"name\": \"実行時刻\",
                    \"value\": \"${TIMESTAMP}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"ワークフロー\",
                    \"value\": \"[${GITHUB_WORKFLOW}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})\",
                    \"inline\": false
                  }
                ],
                \"footer\": {
                  \"text\": \"GitHub Actions - Supabase Keep-Alive\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" \
            "${DISCORD_WEBHOOK_URL}"
