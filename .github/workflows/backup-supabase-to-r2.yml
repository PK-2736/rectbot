# Clean GitHub Actions workflow for Supabase → Cloudflare R2 backup
# Runs on a self-hosted runner and reads credentials from repository Secrets.

name: Backup Supabase to Cloudflare R2

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 18 * * *' # JST 03:00

jobs:
  backup:
    name: Supabase → R2 Backup
    runs-on: self-hosted
    env:
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure required tools
        run: |
          if ! command -v supabase >/dev/null 2>&1; then echo "ERROR: supabase CLI not installed"; exit 1; fi
          if ! command -v aws >/dev/null 2>&1; then echo "ERROR: awscli not installed"; exit 1; fi

      - name: Make backup script executable
        run: chmod +x ./backup_supabase_to_r2.sh

      - name: Run backup script
        run: ./backup_supabase_to_r2.sh


