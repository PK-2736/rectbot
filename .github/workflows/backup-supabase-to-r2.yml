# Clean GitHub Actions workflow for Supabase → Cloudflare R2 backup
# Runs on a self-hosted runner and reads credentials from repository Secrets.

name: Backup Supabase to Cloudflare R2

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 18 * * *' # JST 03:00

jobs:
  backup:
    name: Supabase → R2 Backup
    runs-on: ubuntu-latest
    env:
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install required tools (supabase CLI, awscli)
        run: |
          set -euo pipefail
          # Install supabase CLI (release binary)
          if ! command -v supabase >/dev/null 2>&1; then
            echo "Installing supabase CLI..."
            sudo curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_$(uname -s)_$(uname -m).tar.gz -o /tmp/supabase.tar.gz
            sudo tar -xzf /tmp/supabase.tar.gz -C /tmp
            sudo mv /tmp/supabase /usr/local/bin/supabase || true
          else
            echo "supabase CLI already installed"
          fi

          # Install AWS CLI v2 (official installer)
          if ! command -v aws >/dev/null 2>&1; then
            echo "Installing AWS CLI v2..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
            sudo apt-get update -y && sudo apt-get install -y unzip
            unzip -q /tmp/awscliv2.zip -d /tmp
            sudo /tmp/aws/install
          else
            echo "awscli already installed"
          fi

      - name: Make backup script executable
        run: chmod +x ./backup_supabase_to_r2.sh

      - name: Run backup script
        run: ./backup_supabase_to_r2.sh


