name: Deploy to Cloudflare Workers
on:
  push:
    branches:
      - "main"
    paths:
      - "backend/**"
    # frontend配下の変更ではこのworkflowはトリガーされません
      
  workflow_dispatch:

jobs:
  cloudflare-deploy:
    runs-on: ubuntu-latest
    # 統一されたAPIトークンを使用
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install Bun
        run: curl -fsSL https://bun.sh/install | bash
        shell: bash
      - name: Add Bun to PATH
        run: echo "$HOME/.bun/bin" >> $GITHUB_PATH
        shell: bash
      - name: Install dependencies
        run: |
          cd backend
          bun install
      - name: Install Wrangler
        run: cd backend && npm install wrangler
        
      - name: Ensure wrangler secrets from GitHub Secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd backend
          set -euo pipefail
          echo "Registering available secrets to Cloudflare (wrangler)..."
          # helper function: register if non-empty
          register_secret(){
            name="$1"
            value="${!2}"
            if [ -n "${value}" ]; then
              echo "Registering $name"
              # retry up to 3 times on transient failures
              attempts=0
              until [ $attempts -ge 3 ]
              do
                printf "%s" "${value}" | npx wrangler secret put "$name" && break
                attempts=$((attempts+1))
                echo "Retry $attempts for $name..."
                sleep 1
              done
            else
              echo "Skipping $name (empty)"
            fi
          }

          # SECURITY_SETUP.md に沿ったシークレット設定
          DISCORD_CLIENT_SECRET="${{ secrets.DISCORD_CLIENT_SECRET }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          SERVICE_TOKEN="${{ secrets.SERVICE_TOKEN }}"

          register_secret DISCORD_CLIENT_SECRET DISCORD_CLIENT_SECRET
          register_secret JWT_SECRET JWT_SECRET
          register_secret SUPABASE_SERVICE_ROLE_KEY SUPABASE_SERVICE_ROLE_KEY
          register_secret SERVICE_TOKEN SERVICE_TOKEN

      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}
          DISCORD_REDIRECT_URI: ${{ secrets.DISCORD_REDIRECT_URI }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          ADMIN_DISCORD_ID: ${{ secrets.ADMIN_DISCORD_ID }}
          VPS_EXPRESS_URL: ${{ secrets.VPS_EXPRESS_URL }}
        run: |
          cd backend
          # デフォルト値を設定（Secretが空の場合）
          DISCORD_REDIRECT_URI="${DISCORD_REDIRECT_URI:-https://api.rectbot.tech/api/discord/callback}"
          VPS_EXPRESS_URL="${VPS_EXPRESS_URL:-https://80cbc750-94a4-4b87-b86d-b328b7e76779.cfargotunnel.com}"
          
          echo "Deploying with environment variables:"
          echo "  DISCORD_CLIENT_ID: ${DISCORD_CLIENT_ID:+set}"
          echo "  DISCORD_REDIRECT_URI: ${DISCORD_REDIRECT_URI}"
          echo "  VPS_EXPRESS_URL: ${VPS_EXPRESS_URL}"
          echo "  ADMIN_DISCORD_ID: ${ADMIN_DISCORD_ID:+set}"
          
          npx wrangler deploy --compatibility-date=2024-01-01 \
            --var DISCORD_CLIENT_ID:"${DISCORD_CLIENT_ID}" \
            --var DISCORD_REDIRECT_URI:"${DISCORD_REDIRECT_URI}" \
            --var SUPABASE_URL:"${SUPABASE_URL}" \
            --var ADMIN_DISCORD_ID:"${ADMIN_DISCORD_ID}" \
            --var VPS_EXPRESS_URL:"${VPS_EXPRESS_URL}"
