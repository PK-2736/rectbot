name: Deploy to Cloudflare Workers
on:
  push:
    branches:
      - "main"
    paths:
      - "backend/**"
    # frontend配下の変更ではこのworkflowはトリガーされません
      
  workflow_dispatch:

jobs:
  cloudflare-deploy:
    runs-on: ubuntu-latest
    # 統一されたAPIトークンを使用
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install Bun
        run: curl -fsSL https://bun.sh/install | bash
        shell: bash
      - name: Add Bun to PATH
        run: echo "$HOME/.bun/bin" >> $GITHUB_PATH
        shell: bash
      - name: Install dependencies
        run: |
          cd backend
          bun install
      - name: Install Wrangler
        run: cd backend && npm install wrangler
        
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd backend
          npx wrangler deploy --compatibility-date=2024-01-01
          
      - name: Update secrets after deployment (always)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd backend
          # 毎回環境変数を更新（必須）
          echo "Updating secrets..."
          echo "${{ secrets.DISCORD_CLIENT_SECRET }}" | npx wrangler secret put DISCORD_CLIENT_SECRET || echo "DISCORD_CLIENT_SECRET update failed"
          echo "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" | npx wrangler secret put SUPABASE_SERVICE_ROLE_KEY || echo "SUPABASE_SERVICE_ROLE_KEY update failed" 
          echo "${{ secrets.REACT_APP_DISCORD_CLIENT_ID }}" | npx wrangler secret put REACT_APP_DISCORD_CLIENT_ID || echo "REACT_APP_DISCORD_CLIENT_ID update failed"
          echo "${{ secrets.REACT_APP_DISCORD_REDIRECT_URI }}" | npx wrangler secret put REACT_APP_DISCORD_REDIRECT_URI || echo "REACT_APP_DISCORD_REDIRECT_URI update failed"
          echo "${{ secrets.SUPABASE_URL }}" | npx wrangler secret put SUPABASE_URL || echo "SUPABASE_URL update failed"
          
      - name: Final deployment verification
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd backend
          echo "Deployment completed successfully!"
          npx wrangler --version
