name: Deploy to Cloudflare Workers
on:
  push:
    branches:
      - "main"
    paths:
      - "backend/**"
    # frontend配下の変更ではこのworkflowはトリガーされません
      
  workflow_dispatch:

jobs:
  cloudflare-deploy:
    runs-on: ubuntu-latest
    # 統一されたAPIトークンを使用
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Install Bun
        run: curl -fsSL https://bun.sh/install | bash
        shell: bash
      - name: Add Bun to PATH
        run: echo "$HOME/.bun/bin" >> $GITHUB_PATH
        shell: bash
      - name: Install dependencies
        run: |
          cd backend
          bun install
      - name: Install Wrangler
        run: cd backend && npm install wrangler
      - name: Set environment variables in wrangler.toml
        run: |
          cd backend
          # [vars]セクションに環境変数を動的に追加
          cat >> wrangler.toml << 'EOF'
          
          # GitHub Actionsから設定される環境変数
          REACT_APP_DISCORD_CLIENT_ID = "${{ secrets.REACT_APP_DISCORD_CLIENT_ID }}"
          REACT_APP_DISCORD_REDIRECT_URI = "${{ secrets.REACT_APP_DISCORD_REDIRECT_URI }}"
          SUPABASE_URL = "${{ secrets.SUPABASE_URL }}"
          EOF
          
      - name: Set Cloudflare Workers secrets
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd backend
          # 機密情報をCloudflare Workersのシークレットストアに設定
          echo "${{ secrets.DISCORD_CLIENT_SECRET }}" | npx wrangler secret put DISCORD_CLIENT_SECRET
          echo "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" | npx wrangler secret put SUPABASE_SERVICE_ROLE_KEY
          
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd backend
          npx wrangler deploy
