name: Restore Supabase From R2

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Target environment (test or prod)'
        required: false
        default: 'test'
      backup_index:
        description: 'Backup index number from R2 list (e.g. 1)'
        required: true
      confirm:
        description: 'Type YES to confirm restore'
        required: true

jobs:
  restore:
    name: Restore Supabase DB
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Setup AWS CLI (R2)
        run: |
          echo "Using Cloudflare R2 credentials for AWS CLI"
          echo "AWS_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=auto" >> $GITHUB_ENV
          echo "AWS_EC2_METADATA_DISABLED=true" >> $GITHUB_ENV

      - name: Create .env.backup file
        run: |
          TARGET_ENV="${{ github.event.inputs.target_env }}"
          if [ -z "$TARGET_ENV" ]; then
            TARGET_ENV="test"
          fi

          if [ "$TARGET_ENV" = "prod" ]; then
            SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF_PROD"
            SUPABASE_DB_PASSWORD="$SUPABASE_DB_PASSWORD_PROD"
          else
            SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF_TEST"
            SUPABASE_DB_PASSWORD="$SUPABASE_DB_PASSWORD_TEST"
          fi

          cat << EOF > .env.backup
          SUPABASE_PROJECT_REF=$SUPABASE_PROJECT_REF
          SUPABASE_DB_PASSWORD=$SUPABASE_DB_PASSWORD
          R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
          EOF

          if [ -n "$SUPABASE_DB_HOST" ]; then echo "SUPABASE_DB_HOST=$SUPABASE_DB_HOST" >> .env.backup; fi
          if [ -n "$SUPABASE_DB_PORT" ]; then echo "SUPABASE_DB_PORT=$SUPABASE_DB_PORT" >> .env.backup; fi
          if [ -n "$SUPABASE_DB_USER" ]; then echo "SUPABASE_DB_USER=$SUPABASE_DB_USER" >> .env.backup; fi
          if [ -n "$SUPABASE_DB_NAME" ]; then echo "SUPABASE_DB_NAME=$SUPABASE_DB_NAME" >> .env.backup; fi
          chmod 600 .env.backup
        env:
          SUPABASE_PROJECT_REF_TEST: ${{ secrets.SUPABASE_PROJECT_REF_TEST }}
          SUPABASE_DB_PASSWORD_TEST: ${{ secrets.SUPABASE_DB_PASSWORD_TEST }}
          SUPABASE_PROJECT_REF_PROD: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_PASSWORD_PROD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_DB_HOST: ${{ secrets.SUPABASE_DB_HOST_TEST }}
          SUPABASE_DB_PORT: ${{ secrets.SUPABASE_DB_PORT_TEST }}
          SUPABASE_DB_USER: ${{ secrets.SUPABASE_DB_USER_TEST }}
          SUPABASE_DB_NAME: ${{ secrets.SUPABASE_DB_NAME_TEST }}

      - name: Confirm restore
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "YES" ]; then
            echo "Confirmation failed. Set input confirm=YES to proceed."
            exit 1
          fi

      - name: Run restore
        run: |
          cd scripts
          printf "yes\n" | ./restore_from_r2.sh "${{ github.event.inputs.backup_index }}"

      - name: Upload restore log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: restore-log
          path: scripts/restore.log
          retention-days: 30
