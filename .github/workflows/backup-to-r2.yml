name: Backup Supabase To R2

on:
  schedule:
    - cron: '0 18 * * 1'
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Target environment (test or prod)'
        required: false
        default: 'test'

jobs:
  backup:
    name: Backup Supabase DB
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /usr/share/keyrings/postgresql.gpg
          echo "deb [signed-by=/usr/share/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt noble-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17

      - name: Setup AWS CLI (R2)
        run: |
          echo "Using Cloudflare R2 credentials for AWS CLI"
          echo "AWS_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=auto" >> $GITHUB_ENV
          echo "AWS_EC2_METADATA_DISABLED=true" >> $GITHUB_ENV

      - name: Create .env.backup file
        run: |
          TARGET_ENV="${{ github.event.inputs.target_env }}"
          if [ -z "$TARGET_ENV" ]; then
            TARGET_ENV="test"
          fi

          if [ "$TARGET_ENV" = "prod" ]; then
            SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF_PROD"
            SUPABASE_DB_PASSWORD="$SUPABASE_DB_PASSWORD_PROD"
            SUPABASE_DB_HOST="$SUPABASE_DB_HOST_PROD"
            SUPABASE_DB_PORT="$SUPABASE_DB_PORT_PROD"
            SUPABASE_DB_USER="$SUPABASE_DB_USER_PROD"
            SUPABASE_DB_NAME="$SUPABASE_DB_NAME_PROD"
          else
            SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF_TEST"
            SUPABASE_DB_PASSWORD="$SUPABASE_DB_PASSWORD_TEST"
            SUPABASE_DB_HOST="$SUPABASE_DB_HOST_TEST"
            SUPABASE_DB_PORT="$SUPABASE_DB_PORT_TEST"
            SUPABASE_DB_USER="$SUPABASE_DB_USER_TEST"
            SUPABASE_DB_NAME="$SUPABASE_DB_NAME_TEST"
          fi

          if [ -z "$SUPABASE_PROJECT_REF" ] || [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "Missing Supabase secrets for target_env=${TARGET_ENV}."
            echo "Set SUPABASE_PROJECT_REF_${TARGET_ENV^^} and SUPABASE_DB_PASSWORD_${TARGET_ENV^^} in GitHub Secrets."
            exit 1
          fi

          cat << EOF > .env.backup
          SUPABASE_PROJECT_REF=$SUPABASE_PROJECT_REF
          SUPABASE_DB_PASSWORD=$SUPABASE_DB_PASSWORD
          R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
          BACKUP_ENV=$TARGET_ENV
          EOF

          if [ -n "$SUPABASE_DB_HOST" ]; then echo "SUPABASE_DB_HOST=$SUPABASE_DB_HOST" >> .env.backup; fi
          if [ -n "$SUPABASE_DB_PORT" ]; then echo "SUPABASE_DB_PORT=$SUPABASE_DB_PORT" >> .env.backup; fi
          if [ -n "$SUPABASE_DB_USER" ]; then echo "SUPABASE_DB_USER=$SUPABASE_DB_USER" >> .env.backup; fi
          if [ -n "$SUPABASE_DB_NAME" ]; then echo "SUPABASE_DB_NAME=$SUPABASE_DB_NAME" >> .env.backup; fi
          chmod 600 .env.backup
        env:
          SUPABASE_PROJECT_REF_TEST: ${{ secrets.SUPABASE_PROJECT_REF_TEST }}
          SUPABASE_DB_PASSWORD_TEST: ${{ secrets.SUPABASE_DB_PASSWORD_TEST }}
          SUPABASE_PROJECT_REF_PROD: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_PASSWORD_PROD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_DB_HOST_TEST: ${{ secrets.SUPABASE_DB_HOST_TEST }}
          SUPABASE_DB_PORT_TEST: ${{ secrets.SUPABASE_DB_PORT_TEST }}
          SUPABASE_DB_USER_TEST: ${{ secrets.SUPABASE_DB_USER_TEST }}
          SUPABASE_DB_NAME_TEST: ${{ secrets.SUPABASE_DB_NAME_TEST }}
          SUPABASE_DB_HOST_PROD: ${{ secrets.SUPABASE_DB_HOST_PROD }}
          SUPABASE_DB_PORT_PROD: ${{ secrets.SUPABASE_DB_PORT_PROD }}
          SUPABASE_DB_USER_PROD: ${{ secrets.SUPABASE_DB_USER_PROD }}
          SUPABASE_DB_NAME_PROD: ${{ secrets.SUPABASE_DB_NAME_PROD }}

      - name: Run backup
        run: |
          chmod +x backup_supabase_to_r2.sh
          ./backup_supabase_to_r2.sh

      - name: Upload backup log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backup-log
          path: backup.log
          retention-days: 30
