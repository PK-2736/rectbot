name: Backup/Restore Test

# P1ä¿®æ­£: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒæ©Ÿèƒ½ã®å‹•ä½œç¢ºèªã‚’è‡ªå‹•åŒ–
# æ¯Žé€±æœˆæ›œæ—¥ã®åˆå‰3æ™‚(JST)ã«å®Ÿè¡Œ + æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

on:
  # å®šæœŸå®Ÿè¡Œ: æ¯Žé€±æœˆæ›œæ—¥ åˆå‰3æ™‚ (JST = UTC+9, ãªã®ã§ 18:00 UTC)
  schedule:
    - cron: '0 18 * * 1'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Target environment (test or prod)'
        required: false
        default: 'test'
  
  # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´æ™‚ã«ã‚‚å®Ÿè¡Œ
  push:
    paths:
      - 'scripts/restore_from_r2.sh'
      - 'scripts/test_restore_from_r2.sh'
      - 'scripts/backup_local_to_r2.sh'
      - 'backup_supabase_to_r2.sh'
      - 'restore_from_r2.sh'
      - '.github/workflows/test-backup-restore.yml'

jobs:
  test-restore:
    name: Test Backup Restore Functionality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Setup AWS CLI (R2)
        run: |
          echo "Using Cloudflare R2 credentials for AWS CLI"
          echo "AWS_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=auto" >> $GITHUB_ENV
          echo "AWS_EC2_METADATA_DISABLED=true" >> $GITHUB_ENV
      
      - name: Create .env.backup file
        run: |
          TARGET_ENV="${{ github.event.inputs.target_env }}"
          if [ -z "$TARGET_ENV" ]; then
            TARGET_ENV="test"
          fi

          if [ "$TARGET_ENV" = "prod" ]; then
            SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF_PROD"
            SUPABASE_DB_PASSWORD="$SUPABASE_DB_PASSWORD_PROD"
          else
            SUPABASE_PROJECT_REF="$SUPABASE_PROJECT_REF_TEST"
            SUPABASE_DB_PASSWORD="$SUPABASE_DB_PASSWORD_TEST"
          fi

          cat << EOF > .env.backup
          SUPABASE_PROJECT_REF=$SUPABASE_PROJECT_REF
          SUPABASE_DB_PASSWORD=$SUPABASE_DB_PASSWORD
          R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME=${{ secrets.R2_BUCKET_NAME }}
          EOF
          chmod 600 .env.backup
        env:
          SUPABASE_PROJECT_REF_TEST: ${{ secrets.SUPABASE_PROJECT_REF_TEST }}
          SUPABASE_DB_PASSWORD_TEST: ${{ secrets.SUPABASE_DB_PASSWORD_TEST }}
          SUPABASE_PROJECT_REF_PROD: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_PASSWORD_PROD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      
      - name: Run backup restore test
        id: test
        run: |
          cd scripts
          ./test_restore_from_r2.sh
      
      - name: Check test results
        if: always()
        run: |
          if [ -f scripts/test_restore.log ]; then
            echo "=========================================="
            echo "ãƒ†ã‚¹ãƒˆçµæžœãƒ­ã‚°:"
            echo "=========================================="
            cat scripts/test_restore.log
            echo "=========================================="
          fi
      
      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backup-restore-test-log
          path: scripts/test_restore.log
          retention-days: 30
      
      - name: Notify on failure (Discord)
        if: failure() && github.event_name == 'schedule'
        run: |
          # Discord Webhook ã§é€šçŸ¥ (DISCORD_WEBHOOK_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ)
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ†ã‚¹ãƒˆå¤±æ•—",
                  "description": "å®šæœŸå®Ÿè¡Œã•ã‚ŒãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "Repository",
                      "value": "${{ github.repository }}",
                      "inline": true
                    },
                    {
                      "name": "Workflow",
                      "value": "Backup/Restore Test",
                      "inline": true
                    },
                    {
                      "name": "Run",
                      "value": "[#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                    }
                  ],
                  "timestamp": "${{ github.event.head_commit.timestamp }}"
                }]
              }'
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒãƒ†ã‚¹ãƒˆçµæžœ ðŸ”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test.outcome }}" == "success" ]; then
            echo "âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "å¾©å…ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯æ­£å¸¸ã«å‹•ä½œã™ã‚‹æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "è©³ç´°ã¯ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ãƒ†ã‚¹ãƒˆé …ç›®" >> $GITHUB_STEP_SUMMARY
          echo "1. å¿…é ˆç’°å¢ƒå¤‰æ•°ã®å­˜åœ¨ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "2. AWS CLI ã®å­˜åœ¨ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "3. PostgreSQL ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (psql) ã®å­˜åœ¨ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "4. Cloudflare R2 ãƒã‚±ãƒƒãƒˆã¸ã®æŽ¥ç¶šãƒ†ã‚¹ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "5. R2 å†…ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "6. Supabase ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æŽ¥ç¶šãƒ†ã‚¹ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "7. å¾©å…ƒã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å­˜åœ¨ç¢ºèª" >> $GITHUB_STEP_SUMMARY
